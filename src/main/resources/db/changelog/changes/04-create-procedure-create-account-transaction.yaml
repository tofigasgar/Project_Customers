databaseChangeLog:
  - changeSet:
      id: 4
      author: tofig
      changes:
        - sql:
            splitStatements: false
            stripComments: false
            sql: |
              
              CREATE PROCEDURE create_account_transaction(
                  IN p_account_id BIGINT,
                  IN p_amount DECIMAL(15,2),
                  IN p_description VARCHAR(255),
                  IN p_type VARCHAR(20)
              )
              BEGIN
                  DECLARE v_before_balance DECIMAL(15,2);
                  DECLARE v_after_balance DECIMAL(15,2);
                  DECLARE v_status VARCHAR(20);
                  DECLARE v_active BOOLEAN;
                  DECLARE v_id BIGINT;
                  DECLARE v_exists INT DEFAULT 0;
              
                  -- 1. Hesab mövcudluğunu yoxla
                  SELECT COUNT(*) INTO v_exists
                  FROM accounts
                  WHERE id = p_account_id;
              
                  IF v_exists = 0 THEN
                      SIGNAL SQLSTATE '45000'
                          SET MESSAGE_TEXT = 'Account not found';
                  END IF;
              
                  -- 2. Hesab məlumatlarını oxu
                  SELECT balance, status, active
                  INTO v_before_balance, v_status, v_active
                  FROM accounts
                  WHERE id = p_account_id
                      FOR UPDATE;
              
                  -- 3. Aktivlik və status yoxlamaları
                  IF v_active = FALSE THEN
                      SIGNAL SQLSTATE '45000'
                          SET MESSAGE_TEXT = 'Account is not ACTIVE';
                  END IF;
              
                  IF v_status = 'INACTIVE' THEN
                      SIGNAL SQLSTATE '45000'
                          SET MESSAGE_TEXT = 'Account is INACTIVE';
                  ELSEIF v_status = 'BLOCKED' THEN
                      SIGNAL SQLSTATE '45000'
                          SET MESSAGE_TEXT = 'Account is BLOCKED';
                  END IF;
              
                  -- 4. Balans hesablanması
                  IF p_type = 'DEPOSIT' THEN
                      SET v_after_balance = v_before_balance + p_amount;
                  ELSEIF p_type = 'WITHDRAW' THEN
                      IF v_before_balance < p_amount THEN
                          SIGNAL SQLSTATE '45000'
                              SET MESSAGE_TEXT = 'Insufficient funds';
                      END IF;
                      SET v_after_balance = v_before_balance - p_amount;
                  ELSE
                      SIGNAL SQLSTATE '45000'
                          SET MESSAGE_TEXT = 'Invalid transaction type';
                  END IF;
              
                  -- 5. Transaction qeydiyyatı
                  INSERT INTO account_transaction(
                      amount, before_balance, after_balance,
                      description, type, account_id,
                      created_at, updated_at, active
                  )
                  VALUES (
                             p_amount, v_before_balance, v_after_balance,
                             p_description, p_type, p_account_id,
                             NOW(), NOW(), TRUE
                         );
              
                  SET v_id = LAST_INSERT_ID();
              
                  -- 6. Hesab balansını yenilə
                  UPDATE accounts
                  SET balance = v_after_balance,
                      updated_at = NOW()
                  WHERE id = p_account_id;
              
                  -- 7. Cavab qaytar
                  SELECT
                      at.id,
                      at.amount,
                      at.before_balance AS beforeBalance,
                      at.after_balance AS afterBalance,
                      at.description,
                      at.type,
                      a.account_number AS accountNumber,
                      a.status AS accountStatus
                  FROM account_transaction at
                           JOIN accounts a ON at.account_id = a.id
                  WHERE at.id = v_id;
              
              END
